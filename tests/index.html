<!DOCTYPE html>
<html>
  <head>
    <title>PKCE Test</title>
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
  </head>
  <body>
    <button onclick="startAuth()">Authorize</button>
    <script>
      function generateRandomString(length) {
        const chars =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
        let result = "";
        for (let i = 0; i < length; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      }

      function base64urlEncode(str) {
        return btoa(str)
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=+$/, "");
      }

      function startAuth() {
        const codeVerifier = generateRandomString(64);
        const codeChallenge = base64urlEncode(sha256(codeVerifier));
        localStorage.setItem("code_verifier", codeVerifier);

        const authUrl = `http://localhost:9001/oauth2/authorize?client_id=spa-client&redirect_uri=http://localhost:3000/callback&response_type=code&scope=read%20write%20openid&code_challenge=${codeChallenge}&code_challenge_method=S256`;
        window.location.href = authUrl;
      }

      // Handle callback
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");
      if (code) {
        const codeVerifier = localStorage.getItem("code_verifier");
        fetch("http://localhost:9001/oauth2/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `grant_type=authorization_code&client_id=spa-client&code=${code}&redirect_uri=http://localhost:3000/callback&code_verifier=${codeVerifier}`,
        })
          .then((response) => response.json())
          .then((data) => console.log(data))
          .catch((error) => console.error("Error:", error));
      }
    </script>
  </body>
</html>
